using SpreadsheetGrid_Framework;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using SS;

namespace SpreadsheetGrid_Core
{
    public partial class Form1 : Form
    {
        Spreadsheet spreadsheet = new Spreadsheet();
        public Form1()
        {
            this.grid_widget = new SpreadsheetGridWidget();

            // Call the AutoGenerated code
            InitializeComponent();

            // Add event handler and select a start cell
            grid_widget.SelectionChanged += DisplaySelection;
            grid_widget.SetSelection(2, 2, false);


        }

        /// <summary>
        /// Given a spreadsheet, find the current selected cell and
        /// create a popup that contains the information from that cell
        /// </summary>
        /// <param name="ss"></param>
        private void DisplaySelection(SpreadsheetGridWidget ss)
        {
            int row, col;

            string value;
            ss.GetSelection(out col, out row);
            ss.GetValue(col, row, out value);
            // if cell is "" (empty) puts the current date and time when clicked on
            if (value == "")
            {
                ss.SetValue(col, row, DateTime.Now.ToLocalTime().ToString("T"));
                ss.GetValue(col, row, out value);
                MessageBox.Show("Selection: column " + col + " row " + row + " value " + value);
            }
        }

        // Deals with the New menu
        private void NewToolStripMenuItem_Click(object sender, EventArgs e)
        {
            // Tell the application context to run the form on the same
            // thread as the other forms.
            Spreadsheet_Window.getAppContext().RunForm(new Form1());
        }

        // Deals with the Close menu
        private void CloseToolStripMenuItem_Click(object sender, EventArgs e)
        {
            Close();
        }

        private void saveToolStripMenuItem_Click(object sender, EventArgs e)
        {

        }

        private void openToolStripMenuItem_Click(object sender, EventArgs e)
        {

        }

        /// <summary>
        /// Example of how to use a button
        /// </summary>
        /// <param name="sender"> not used </param>
        /// <param name="e"> not used </param>
        private void sample_button_Click(object sender, EventArgs e)
        {
            // prints hello in cell E6 when button1 is pressed
            grid_widget.SetValue(4, 5, "hello");
            grid_widget.SetSelection(4, 5);
        }

        /// <summary>
        /// Checkbox handler
        /// </summary>
        /// <param name="sender"> the checkbox (note the casting operator as)</param>
        /// <param name="e">not used</param>
        private void sample_checkbox_CheckedChanged(object sender, EventArgs e)
        {
            // sets cell B2 value as "checked" first time the checkbox is selected
            if ((sender as CheckBox).Checked)
            {
                grid_widget.SetValue(1, 1, "checked");
            }
            // sets cell B2 value as "not checked" when the checkbox is deselected (the cell value is then either "checked" or "not checked") 
            else
            {
                grid_widget.SetValue(1, 1, "not checked");
            }

        }

        /// <summary>
        /// Textbox handler
        /// </summary>
        /// <param name="sender"> the textbox </param>
        /// <param name="e">not used</param>
        private void sample_textbox_TextChanged(object sender, EventArgs e)
        {
            TextBox box = sender as TextBox;

            grid_widget.SetValue(2, 2, box.Text);

        }

        private void CellContentsTextBox_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (sender is TextBox)
                {
                    UpdateContentsTextBox();
                    UpdateValueTextBox();
                    UpdateSelectedCellTextBox();
                }
            }
        }

        // helper methods for CellContentsTextBox_KeyDown
        /// <summary>
        /// Updates the SelectedCellTextBox with the appropriate cell name
        /// </summary>
        private void UpdateSelectedCellTextBox()
        {
            // get column and row location
            grid_widget.GetSelection(out int col, out int row);
            // use ascii value to convert column location to a letter
            char letter = (char)('A' + col);
            string rowLocation = "" + letter;
            // append rowLocation and col.ToString() and set to cellLocation
            string cellLocation = rowLocation + (row + 1).ToString();
            SelectedCellTextBox.Text = cellLocation;
        }
        /// <summary>
        /// Updates CellValueTextBox, if a string is entered the text box is updated with a string, if a double is entered the text box is updated with a double,
        /// if a formula is is entered the formula is evaluated then the text box is updated with the result.
        /// </summary>
        private void UpdateValueTextBox()
        {
            // get column and row location
            grid_widget.GetSelection(out int col, out int row);
            // use ascii value to convert column location to a letter
            char letter = (char)('A' + col);
            string rowLocation = "" + letter;
            // append rowLocation and col.ToString() and set to cellLocation
            string cellLocation = rowLocation + col.ToString();
            // calculate value of cell
            spreadsheet.GetCellValue(cellLocation);
            grid_widget.GetValue(col, row, out string value);
            CellValueTextBox.AppendText(spreadsheet.GetCellValue(cellLocation).ToString());
        }
        /// <summary>
        /// Updates CellContentsTextBox with entered text
        /// </summary>
        private void UpdateContentsTextBox()
        {
            // get column and row location
            grid_widget.GetSelection(out int col, out int row);
            // use ascii value to convert column location to a letter
            char letter = (char)('A' + col);
            string rowLocation = "" + letter;
            // set cell location with rowLocation and col.ToString
            string cellLocation = rowLocation + col.ToString();
            // setContentsOfCell in our spreadsheet
            spreadsheet.SetContentsOfCell(cellLocation, CellContentsTextBox.Text);
            // set cell with same contents as CellContentsTextBox
            grid_widget.SetValue(col, row, CellContentsTextBox.Text);
        }

        private void SelectedCellLabel_Click_1(object sender, EventArgs e)
        {
            // TODO need to update name, value, and contents textbox
        }

        private void CellValueLabel_Click(object sender, EventArgs e)
        {

        }

        private void CellContentsLabel_Click(object sender, EventArgs e)
        {

        }
    }
}
